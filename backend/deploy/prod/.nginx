# ==================================================================
#  1. GLOBALE WEITERLEITUNGEN
# ==================================================================

# ------------------------------------------------------------------
#  A. Alle HTTP (Port 80) Anfragen auf HTTPS umleiten
# ------------------------------------------------------------------
# Dieser EINE Block fängt alle Anfragen an Port 80 für alle Domains ab
# und leitet sie auf die entsprechende HTTPS-Version weiter.
#
server {
    listen 80;
    listen [::]:80;
    server_name www.nexora-ai.de nexora-ai.de minidb.nexora-ai.de db.nexora-ai.de;

    # Anfragen für Let's Encrypt erlauben, ohne Umleitung
    location ^~ /.well-known/acme-challenge/ {
        # Der Root-Pfad sollte für die Zertifikatsvalidierung korrekt sein
        root /home/nexora-ai/htdocs/www.nexora-ai.de; 
        allow all;
        default_type "text/plain";
    }

    # Alle anderen Anfragen permanent (301) auf HTTPS umleiten
    location / {
        return 301 https://$host$request_uri;
    }
}

# ------------------------------------------------------------------
#  B. nexora-ai.de (non-www) auf www.nexora-ai.de umleiten
# ------------------------------------------------------------------
# Dieser Block fängt alle HTTPS-Anfragen an die Domain ohne "www" ab
# und leitet sie permanent auf die "www"-Version um.
#
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name nexora-ai.de;

    # SSL Zertifikate sind für die HTTPS-Verbindung vor der Umleitung notwendig
    {{ssl_certificate}}
    {{ssl_certificate_key}}
    
    # Permanente Weiterleitung zur kanonischen www-Domain
    return 301 https://www.nexora-ai.de$request_uri;
}


# ==================================================================
#  2. PROXIES FÜR SPEZIFISCHE DIENSTE (HTTPS)
# ==================================================================

# ------------------------------------------------------------------
#  A. MiniDB Service
# ------------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name minidb.nexora-ai.de;

    {{root}}
    {{ssl_certificate}}
    {{ssl_certificate_key}}

    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ------------------------------------------------------------------
#  B. pgAdmin Service
# ------------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name db.nexora-ai.de;

    {{root}}
    {{ssl_certificate}}
    {{ssl_certificate_key}}
    {{nginx_access_log}}
    {{nginx_error_log}}
    
    location / {
        proxy_pass http://127.0.0.1:5090;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Lange Timeouts für stabile WebSocket-Verbindungen in pgAdmin
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}


# ==================================================================
#  3. HAUPTANWENDUNG: www.nexora-ai.de
# ==================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    listen 443 quic;
    listen [::]:443 quic;
    
    server_name www.nexora-ai.de;

    # SSL, Root und Logs
    {{ssl_certificate}}
    {{ssl_certificate_key}}
    {{root}}
    {{nginx_access_log}}
    {{nginx_error_log}}
    
    # Globale Einstellungen
    {{settings}}
    include /etc/nginx/global_settings;

    # --- IMMER AKTIV: Routen für API, Sicherheit ---
    location ^~ /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        try_files $uri @reverse_proxy;
    }
    location ~ /\.env { deny all; return 404; }
    location ^~ /.well-known { auth_basic off; allow all; try_files $uri @reverse_proxy; }
    
    # --- MODUS UMSCHALTEN: PRODUKTION vs. WARTUNG ---
    # Zum Wechseln, den einen Block auskommentieren und den anderen aktivieren.
    
    # -------------------- PRODUKTIONSMODUS (Standard) -------------------
    location /assets/ {
        alias /home/nexora-ai/htdocs/www.nexora-ai.de/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }
    location / {
        root /home/nexora-ai/htdocs/www.nexora-ai.de/dist;
        try_files $uri /index.html;
    }
    # ---------------- ENDE PRODUKTIONSMODUS ------------------------
    
    # -------------------- WARTUNGSMODUS (Standardmäßig auskommentiert) -----
    /*
    location / {
        root /home/nexora-ai/htdocs/www.nexora-ai.de/maintanance;
        try_files $uri /index.html;
    }
    */
    # ---------------- ENDE WARTUNGSMODUS ---------------------------

    # --- REVERSE PROXY KONFIGURATION (für @reverse_proxy) ---
    location @reverse_proxy {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
    }
}

